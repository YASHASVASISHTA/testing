<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ExamAce</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #374151;
            background-color: #ffffff;
            min-height: 100vh;
        }

        /* Color variables matching the design brief */
        :root {
            --primary: #15803d;
            --primary-foreground: #ffffff;
            --secondary: #84cc16;
            --secondary-foreground: #374151;
            --background: #ffffff;
            --foreground: #374151;
            --card: #f0fdf4;
            --card-foreground: #374151;
            --muted: #f0fdf4;
            --muted-foreground: #4b5563;
            --border: #d1d5db;
            --input: #e5e7eb;
            --ring: #84cc16;
            --destructive: #ea580c;
            --destructive-foreground: #ffffff;
        }

        /* Navigation styles */
        .navbar {
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 0 1rem;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 4rem;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-link {
            color: var(--foreground);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 2rem;
            height: 2rem;
            background-color: var(--primary);
            color: var(--primary-foreground);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .logout-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--foreground);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background-color: var(--muted);
        }

        /* Mobile menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--foreground);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-menu {
            display: none;
            background-color: var(--card);
            border-top: 1px solid var(--border);
            padding: 1rem;
        }

        .mobile-menu.active {
            display: block;
        }

        .mobile-nav-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Main content */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .welcome-section {
            margin-bottom: 2rem;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--foreground);
            margin-bottom: 0.5rem;
        }

        .welcome-subtitle {
            color: var(--muted-foreground);
            font-size: 1.125rem;
        }

        /* Grid layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        /* Card styles */
        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--foreground);
        }

        .card-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .icon-primary {
            background-color: rgba(21, 128, 61, 0.1);
            color: var(--primary);
        }

        .icon-secondary {
            background-color: rgba(132, 204, 22, 0.1);
            color: var(--secondary);
        }

        .icon-destructive {
            background-color: rgba(234, 88, 12, 0.1);
            color: var(--destructive);
        }

        /* Stats card */
        .stat-card {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            color: var(--muted-foreground);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Test list */
        .test-list {
            list-style: none;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .test-item:hover {
            background-color: var(--muted);
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-info h4 {
            font-weight: 600;
            color: var(--foreground);
            margin-bottom: 0.25rem;
        }

        .test-meta {
            color: var(--muted-foreground);
            font-size: 0.875rem;
        }

        .test-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-available {
            background-color: rgba(21, 128, 61, 0.1);
            color: var(--primary);
        }

        .status-completed {
            background-color: rgba(132, 204, 22, 0.1);
            color: var(--secondary);
        }

        .status-missed {
            background-color: rgba(234, 88, 12, 0.1);
            color: var(--destructive);
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary:hover {
            background-color: #166534;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
        }

        .btn-secondary:hover {
            background-color: #65a30d;
        }

        .btn-outline {
            background: none;
            border: 1px solid var(--border);
            color: var(--foreground);
        }

        .btn-outline:hover {
            background-color: var(--muted);
        }

        /* Quick actions */
        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .welcome-title {
                font-size: 1.5rem;
            }

            .quick-actions {
                flex-direction: column;
            }

            .test-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .main-container {
                padding: 1rem;
            }

            .card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">ExamAce</a>
            
            <ul class="nav-links">
                <li><a href="dashboard.html" class="nav-link active">Dashboard</a></li>
                <li><a href="test-selection.html" class="nav-link">Mock Tests</a></li>
                <li><a href="analytics.html" class="nav-link">Analytics</a></li>
                <li><a href="profile.html" class="nav-link">Profile</a></li>
            </ul>

            <div class="nav-user">
                <div class="user-avatar" id="user-avatar">U</div>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </div>

            <button class="mobile-menu-btn" id="mobile-menu-btn">&#9776;</button>
        </div>

        <div class="mobile-menu" id="mobile-menu">
            <ul class="mobile-nav-links">
                <li><a href="dashboard.html" class="nav-link active">Dashboard</a></li>
                <li><a href="test-selection.html" class="nav-link">Mock Tests</a></li>
                <li><a href="analytics.html" class="nav-link">Analytics</a></li>
                <li><a href="profile.html" class="nav-link">Profile</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Welcome Section -->
        <section class="welcome-section">
            <h1 class="welcome-title" id="welcome-title">Welcome back!</h1>
            <p class="welcome-subtitle">Ready to continue your exam preparation?</p>
        </section>

        <!-- Stats Overview -->
        <section class="stats-grid">
            <div class="card stat-card">
                <span class="stat-number" id="tests-taken">0</span>
                <div class="stat-label">Tests Taken</div>
            </div>
            <div class="card stat-card">
                <span class="stat-number" id="avg-score">0%</span>
                <div class="stat-label">Average Score</div>
            </div>
            <div class="card stat-card">
                <span class="stat-number" id="study-hours">0</span>
                <div class="stat-label">Study Hours</div>
            </div>
            <div class="card stat-card">
                <span class="stat-number" id="rank">N/A</span>
                <div class="stat-label">Current Rank</div>
            </div>
        </section>

        <!-- Dashboard Grid -->
        <section class="dashboard-grid">
            <!-- Upcoming Tests -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Upcoming Tests</h2>
                    <div class="card-icon icon-primary">&#128221;</div>
                </div>
                <ul class="test-list" id="upcoming-tests">
                    <!-- Upcoming tests will be loaded here -->
                </ul>
                <div class="quick-actions">
                    <a href="test-selection.html" class="btn btn-primary">View All Tests</a>
                </div>
            </div>

            <!-- Recent Performance -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Performance</h2>
                    <div class="card-icon icon-secondary">&#128202;</div>
                </div>
                <ul class="test-list" id="recent-tests">
                   <!-- Recent performance will be loaded here -->
                </ul>
                <div class="quick-actions">
                    <a href="analytics.html" class="btn btn-secondary">View Analytics</a>
                </div>
            </div>
        </section>
    </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCQ34ZAWWCMuaQ01fvX0sI-YdklK0mJ5aw",
          authDomain: "testseries-38752.firebaseapp.com",
          projectId: "testseries-38752",
          storageBucket: "testseries-38752.firebasestorage.app",
          messagingSenderId: "519384534407",
          appId: "1:519384534407:web:201265a9d703708334d722",
          measurementId: "G-XBHHK5W8VE"
        };
      
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                loadDashboardData(user);
            } else {
                // User is signed out
                window.location.href = 'login.html';
            }
        });

        async function loadDashboardData(user) {
            try {
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    updateWelcomeMessage(userData);
                }

                // Fetch data in parallel
                const [results, upcomingTests] = await Promise.all([
                    fetchTestResults(user.uid),
                    fetchUpcomingTests()
                ]);

                updateRecentPerformance(results);
                updateStats(results, docSnap.data());
                updateUpcomingTests(upcomingTests);

            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }

        async function fetchTestResults(userId) {
            const resultsCol = collection(db, `users/${userId}/results`);
            const q = query(resultsCol, orderBy("completedAt", "desc"));
            const resultsSnapshot = await getDocs(q);
            return resultsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        }
        
        async function fetchUpcomingTests() {
            const testsCol = collection(db, "tests");
            const q = query(testsCol, limit(3)); // Get first 3 tests as "upcoming"
            const testsSnapshot = await getDocs(q);
            return testsSnapshot.docs.map(doc => doc.data());
        }

        function updateWelcomeMessage(userData) {
            document.getElementById('welcome-title').textContent = `Welcome back, ${userData.name}!`;
            document.getElementById('user-avatar').textContent = userData.name.charAt(0).toUpperCase();
        }
        
        function updateRecentPerformance(results) {
            const recentTestsContainer = document.getElementById('recent-tests');
            if(results.length === 0) {
                recentTestsContainer.innerHTML = '<li><p style="padding: 1rem 0;">No tests taken yet.</p></li>';
                return;
            }

            const recentResults = results.slice(0, 3); // Already sorted by query
            
            recentTestsContainer.innerHTML = recentResults.map(result => `
                <li class="test-item">
                    <div class="test-info">
                        <h4>${result.testData.title}</h4>
                        <div class="test-meta">Score: ${result.finalScore}/${result.testData.marks} &bull; ${result.percentage.toFixed(1)}%</div>
                    </div>
                    <span class="test-status status-completed">Completed</span>
                </li>
            `).join('');
        }
        
        function updateUpcomingTests(tests) {
            const upcomingTestsContainer = document.getElementById('upcoming-tests');
            if (tests.length === 0) {
                upcomingTestsContainer.innerHTML = '<li><p style="padding: 1rem 0;">No new tests available.</p></li>';
                return;
            }
            upcomingTestsContainer.innerHTML = tests.map(test => `
                 <li class="test-item" style="cursor: pointer;" data-testid="${test.id}">
                    <div class="test-info">
                        <h4>${test.title}</h4>
                        <div class="test-meta">${test.subjects.join(', ')} &bull; ${test.duration} mins</div>
                    </div>
                    <span class="test-status status-available">Available</span>
                </li>
            `).join('');
            
            // Add click listeners
            upcomingTestsContainer.querySelectorAll('.test-item').forEach(item => {
                item.addEventListener('click', () => {
                    const test = tests.find(t => t.id === item.dataset.testid);
                    sessionStorage.setItem('current_test', JSON.stringify(test));
                    window.location.href = 'test-instruction.html';
                });
            });
        }

        function updateStats(results, userData) {
            const testsTaken = results.length;
            const totalPercentage = results.reduce((acc, curr) => acc + curr.percentage, 0);
            const avgScore = testsTaken > 0 ? (totalPercentage / testsTaken).toFixed(0) : 0;
            const totalTimeMinutes = results.reduce((acc, curr) => acc + (curr.timeTaken || 0), 0) / 60;
            
            document.getElementById('tests-taken').textContent = testsTaken;
            document.getElementById('avg-score').textContent = `${avgScore}%`;
            document.getElementById('study-hours').textContent = Math.round(totalTimeMinutes / 60);
            // Rank needs a leaderboard implementation
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Sign out error', error);
            });
        });

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('active');
        });
    </script>

</body>
</html>

