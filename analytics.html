<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analytics - ExamAce</title>
    <!-- Chart.js for creating charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Reusing styles from results.html for a consistent look and feel */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; line-height: 1.6; color: #374151; background-color: #f9fafb; }
        :root {
            --primary: #15803d; --primary-foreground: #ffffff; --secondary: #84cc16;
            --background: #ffffff; --foreground: #374151; --card: #ffffff;
            --muted: #f3f4f6; --muted-foreground: #6b7280; --border: #e5e7eb;
            --destructive: #dc2626; --warning: #f59e0b; --success: #16a34a;
        }
        /* Navigation */
        .navbar { background-color: var(--card); border-bottom: 1px solid var(--border); padding: 0 1rem; position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 4rem; }
        .nav-brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); text-decoration: none; }
        .nav-links { display: flex; gap: 2rem; list-style: none; }
        .nav-link { color: var(--foreground); text-decoration: none; font-weight: 500; }
        .nav-link.active { color: var(--primary); font-weight: 600; }
        .nav-user { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 2rem; height: 2rem; background-color: var(--primary); color: var(--primary-foreground); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .logout-btn { background: none; border: 1px solid var(--border); color: var(--foreground); padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; }
        .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.75rem; cursor: pointer; color: var(--foreground); }
        .mobile-menu { display: none; background-color: var(--card); border-top: 1px solid var(--border); padding: 1rem; position: absolute; top: 4rem; left: 0; right: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .mobile-menu.active { display: block; }
        .mobile-nav-links { list-style: none; display: flex; flex-direction: column; gap: 1rem; }

        /* Main Content */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
        #loading-state, #no-data-state { text-align: center; padding: 4rem; }
        #no-data-state a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .page-title { font-size: 2.25rem; font-weight: 700; margin-bottom: 2rem; color: var(--primary); }
        .card { background-color: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem; }
        .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }

        /* Stats & Analysis Grids */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .stat-card { text-align: center; padding: 1.5rem; background-color: var(--muted); border-radius: 0.5rem; }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 1rem; color: var(--muted-foreground); margin-top: 0.5rem; }
        
        /* MODIFIED: Changed analysis-grid to single column */
        .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        .chart-container { position: relative; height: 350px; } /* NEW: Fixed height for charts */
        
        /* NEW: Styles for topics list */
        .topics-list { list-style: none; }
        .topics-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
        .topics-list li:last-child { border-bottom: none; }
        .topic-name { font-weight: 500; }
        .topic-count { background-color: #fee2e2; color: #b91c1c; font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 999px; font-weight: 600;}

        /* Test History Table */
        .table-container { overflow-x: auto; }
        .test-history-table { width: 100%; border-collapse: collapse; }
        .test-history-table th, .test-history-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .test-history-table th { font-weight: 600; font-size: 0.875rem; color: var(--muted-foreground); text-transform: uppercase; }
        .test-history-table td { font-weight: 500; }
        .btn { padding: 0.5rem 1rem; border: 1px solid var(--primary); border-radius: 0.375rem; font-weight: 500; cursor: pointer; text-decoration: none; text-align: center; transition: all 0.2s; font-size: 0.875rem; background-color: transparent; color: var(--primary); display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:hover { background-color: var(--primary); color: var(--primary-foreground); }

        @media (max-width: 768px) {
            .nav-links, .nav-user { display: none; }
            .mobile-menu-btn { display: block; }
            .page-title { font-size: 1.75rem; }
            .stat-value { font-size: 2rem; }
            
            .test-history-table thead { display: none; }
            .test-history-table, .test-history-table tbody, .test-history-table tr, .test-history-table td { display: block; width: 100%; }
            .test-history-table tr { margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.5rem; }
            .test-history-table td { text-align: right; position: relative; padding-left: 50%; border-bottom: 1px solid var(--border); }
            .test-history-table td:last-child { border-bottom: 0; }
            .test-history-table td::before { content: attr(data-label); position: absolute; left: 0.75rem; width: 45%; padding-right: 0.5rem; text-align: left; font-weight: bold; color: var(--foreground); }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="dashboard.html" class="nav-brand">ExamAce</a>
            <ul class="nav-links">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="test-selection.html" class="nav-link">Mock Tests</a></li>
                <li><a href="analytics.html" class="nav-link active">Analytics</a></li>
                <li><a href="resources.html" class="nav-link">Resources</a></li>
                <li><a href="tips.html" class="nav-link">Tips & Revision</a></li>
                <li><a href="profile.html" class="nav-link">Profile</a></li>
            </ul>
            <div class="nav-user">
                <div class="user-avatar" id="user-avatar">U</div>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn">&#9776;</button>
        </div>
        <div class="mobile-menu" id="mobile-menu">
            <ul class="mobile-nav-links">
                 <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="test-selection.html" class="nav-link">Mock Tests</a></li>
                <li><a href="analytics.html" class="nav-link active">Analytics</a></li>
                <li><a href="resources.html" class="nav-link">Resources</a></li>
                <li><a href="tips.html" class="nav-link">Tips & Revision</a></li>
                <li><a href="profile.html" class="nav-link">Profile</a></li>
                <li><a href="#" id="mobile-logout-btn" class="nav-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-container">
        <div id="loading-state"><h1>Loading Analytics...</h1></div>
        <div id="no-data-state" style="display:none;">
            <h1>No Analytics Data Found</h1>
            <p style="margin-top: 1rem;">You need to complete at least one test to see your performance analysis.</p>
            <p style="margin-top: 1.5rem;"><a href="test-selection.html">Take a Test Now</a></p>
        </div>

        <div id="analytics-content" style="display:none;">
            <h1 class="page-title">Your Performance Analytics</h1>
            
            <div class="stats-grid card">
                <div class="stat-card"><div class="stat-value" id="stat-tests-taken">0</div><div class="stat-label">Tests Taken</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-avg-score">0%</div><div class="stat-label">Average Score</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-avg-accuracy">0%</div><div class="stat-label">Overall Accuracy</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-total-time">0m</div><div class="stat-label">Total Time Spent</div></div>
            </div>

            <div class="analysis-grid">
                <div class="card">
                    <h2 class="card-title">Recent Performance (Last 6 Tests)</h2>
                    <div class="chart-container">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-title">Overall Subject Performance</h2>
                     <div class="chart-container">
                        <canvas id="subject-chart"></canvas>
                    </div>
                </div>
                <!-- NEW: Weak Areas Card -->
                <div class="card">
                    <h2 class="card-title">Top Areas for Improvement</h2>
                    <ul class="topics-list" id="topics-list">
                        <!-- Topics will be dynamically inserted here -->
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Test History</h2>
                <div class="table-container" id="test-history-container">
                    <!-- Table will be inserted here by script -->
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCQ34ZAWWCMuaQ01fvX0sI-YdklK0mJ5aw",
          authDomain: "testseries-38752.firebaseapp.com",
          projectId: "testseries-38752",
          storageBucket: "testseries-38752.firebasestorage.app",
          messagingSenderId: "519384534407",
          appId: "1:519384534407:web:201265a9d703708334d722"
        };
      
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        class AnalyticsPage {
            constructor() {
                this.user = null;
                this.charts = {};
                this.allTestsData = new Map();

                onAuthStateChanged(auth, user => {
                    if (user) {
                        this.user = user;
                        document.getElementById('user-avatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
                        this.fetchAndProcessData();
                    } else {
                        window.location.href = 'login.html';
                    }
                });
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                const handleLogout = () => signOut(auth).catch(e => console.error(e));
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('mobile-logout-btn').addEventListener('click', handleLogout);

                document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                     document.getElementById('mobile-menu').classList.toggle('active');
                });
            }

            async fetchAndProcessData() {
                try {
                    const [testsSnapshot, resultsSnapshot] = await Promise.all([
                        getDocs(collection(db, "tests")),
                        getDocs(query(collection(db, "users", this.user.uid, "results"), orderBy("completedAt", "desc")))
                    ]);
                    
                    testsSnapshot.forEach(doc => this.allTestsData.set(doc.id, doc.data()));

                    const allResults = resultsSnapshot.docs.map(doc => doc.data());

                    if (allResults.length === 0) {
                        this.showNoDataState();
                        return;
                    }
                    
                    // MODIFIED: Get unique results for the history table
                    const uniqueResultsMap = new Map();
                    allResults.forEach(result => {
                        if (!uniqueResultsMap.has(result.testId)) {
                            uniqueResultsMap.set(result.testId, result);
                        }
                    });
                    const uniqueLatestResults = Array.from(uniqueResultsMap.values());
                    
                    this.renderAnalytics(allResults);
                    this.renderTestHistory(uniqueLatestResults); // Pass unique results to history

                } catch (error) {
                    console.error("Error fetching data: ", error);
                    document.getElementById('loading-state').innerHTML = '<h1>Error loading analytics. Please try again.</h1>';
                }
            }
            
            renderAnalytics(allResults) {
                this.renderOverallStats(allResults);
                this.renderPerformanceChart(allResults);
                this.renderSubjectChart(allResults);
                this.renderTopicsList(allResults); // NEW: Render weak areas

                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
            }
            
            renderTestHistory(uniqueResults) {
                const container = document.getElementById('test-history-container');
                if (uniqueResults.length === 0) {
                    container.innerHTML = "<p>No tests completed yet.</p>";
                    return;
                }

                let tableHTML = `
                    <table class="test-history-table">
                        <thead>
                            <tr>
                                <th>Test Name</th>
                                <th>Date Completed</th>
                                <th>Score</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                uniqueResults.forEach(result => {
                    const date = new Date(result.completedAt).toLocaleDateString();
                    tableHTML += `
                        <tr>
                            <td data-label="Test Name">${result.testTitle}</td>
                            <td data-label="Date">${date}</td>
                            <td data-label="Score">${result.percentage.toFixed(1)}%</td>
                            <td data-label="Action">
                                <button class="btn download-btn" data-testid="${result.testId}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                                    <span>Solutions</span>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `</tbody></table>`;
                container.innerHTML = tableHTML;
                
                container.querySelectorAll('.download-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.downloadSolutions(e.currentTarget.dataset.testid);
                    });
                });
            }
            
            // NEW: Function to render topics list
            renderTopicsList(allResults) {
                const topicCounts = {};
                allResults.forEach(result => {
                    if (result.incorrectTopics) {
                        result.incorrectTopics.forEach(topic => {
                            topicCounts[topic] = (topicCounts[topic] || 0) + 1;
                        });
                    }
                });

                const sortedTopics = Object.entries(topicCounts).sort(([,a],[,b]) => b - a);
                const container = document.getElementById('topics-list');
                container.innerHTML = '';

                if (sortedTopics.length === 0) {
                     container.innerHTML = '<li>No specific weak topics found. Great job!</li>';
                     return;
                }

                sortedTopics.slice(0, 5).forEach(([topic, count]) => { // Show top 5
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="topic-name">${topic}</span><span class="topic-count">${count} incorrect</span>`;
                    container.appendChild(li);
                });
            }

            downloadSolutions(testId) {
                const testData = this.allTestsData.get(testId);
                if (!testData) {
                    alert('Could not find the data for this test.');
                    return;
                }

                let solutionText = `Solutions for: ${testData.title}\n`;
                solutionText += "========================================\n\n";

                testData.questions_data.forEach((q, index) => {
                    solutionText += `Q${index + 1}: ${q.questionText}\n`;
                    q.options.forEach((option, optIndex) => {
                        solutionText += `  ${String.fromCharCode(65 + optIndex)}. ${option}\n`;
                    });
                    const correctOptionLetter = String.fromCharCode(65 + q.correctAnswer);
                    const correctOptionText = q.options[q.correctAnswer];
                    solutionText += `\nCorrect Answer: ${correctOptionLetter}. ${correctOptionText}\n`;
                    
                    let formattedSolution = q.solution || 'No detailed solution available.';
                    formattedSolution = formattedSolution.replace(/<br\s*\/?>/gi, '\n').replace(/Solution: /g, '');
                    solutionText += `Solution:\n${formattedSolution}\n`;
                    solutionText += "----------------------------------------\n\n";
                });

                const blob = new Blob([solutionText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const fileName = `${testData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_solutions.txt`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showNoDataState() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('no-data-state').style.display = 'block';
            }

            renderOverallStats(allResults) {
                const totalTests = allResults.length;
                const avgScore = totalTests > 0 ? (allResults.reduce((sum, r) => sum + r.percentage, 0) / totalTests).toFixed(1) : 0;
                const totalCorrect = allResults.reduce((sum, r) => sum + r.correct, 0);
                const totalAttempted = totalCorrect + allResults.reduce((sum, r) => sum + r.incorrect, 0);
                const avgAccuracy = totalAttempted > 0 ? (totalCorrect / totalAttempted * 100).toFixed(1) : 0;
                const totalTimeInMinutes = Math.round(allResults.reduce((sum, r) => sum + r.timeTaken, 0) / 60);

                document.getElementById('stat-tests-taken').textContent = totalTests;
                document.getElementById('stat-avg-score').textContent = `${avgScore}%`;
                document.getElementById('stat-avg-accuracy').textContent = `${avgAccuracy}%`;
                document.getElementById('stat-total-time').textContent = `${totalTimeInMinutes}m`;
            }

            renderPerformanceChart(allResults) {
                // MODIFIED: Slice to last 6 and reverse for chronological order
                const recentResults = allResults.slice(0, 6).reverse();

                const ctx = document.getElementById('performance-chart').getContext('2d');
                if (this.charts.performance) this.charts.performance.destroy();
                
                this.charts.performance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: recentResults.map(r => new Date(r.completedAt).toLocaleDateString()),
                        datasets: [{
                            label: 'Score Percentage',
                            data: recentResults.map(r => r.percentage),
                            borderColor: 'var(--primary)',
                            backgroundColor: 'rgba(21, 128, 61, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            renderSubjectChart(allResults) {
                const subjectData = {};
                allResults.forEach(result => {
                    for (const subjectName in result.subjectWise) {
                        if (!subjectData[subjectName]) subjectData[subjectName] = { correct: 0, incorrect: 0 };
                        subjectData[subjectName].correct += result.subjectWise[subjectName].correct;
                        subjectData[subjectName].incorrect += result.subjectWise[subjectName].incorrect;
                    }
                });

                const labels = Object.keys(subjectData);
                const accuracies = labels.map(label => {
                    const { correct, incorrect } = subjectData[label];
                    return (correct + incorrect) > 0 ? (correct / (correct + incorrect) * 100) : 0;
                });
                
                const ctx = document.getElementById('subject-chart').getContext('2d');
                if (this.charts.subject) this.charts.subject.destroy();

                this.charts.subject = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average Accuracy %',
                            data: accuracies,
                            backgroundColor: 'var(--primary)',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } },
                        indexAxis: 'y'
                    }
                });
            }
        }

        new AnalyticsPage();
    </script>
</body>
</html>

