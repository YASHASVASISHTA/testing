<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Results - ExamAce</title>
    <style>
        /* Reset and base styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; line-height: 1.6; color: #374151; background-color: #f9fafb; }
        :root {
            --primary: #15803d; --primary-foreground: #ffffff; --secondary: #84cc16;
            --background: #ffffff; --foreground: #374151; --card: #ffffff;
            --muted: #f3f4f6; --muted-foreground: #6b7280; --border: #e5e7eb;
            --destructive: #dc2626; --warning: #f59e0b; --success: #16a34a;
        }
        /* Navigation */
        .navbar { background-color: var(--card); border-bottom: 1px solid var(--border); padding: 0 1rem; position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 4rem; }
        .nav-brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); text-decoration: none; }
        .nav-user { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 2rem; height: 2rem; background-color: var(--primary); color: var(--primary-foreground); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }

        /* Main Content */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
        #loading-state { text-align: center; padding: 4rem; }

        /* Summary Header */
        .summary-header { background: linear-gradient(135deg, var(--primary), #166534); color: white; border-radius: 0.75rem; padding: 2rem; margin-bottom: 2rem; text-align: center; }
        .summary-title { font-size: 1.25rem; opacity: 0.9; }
        .summary-test-name { font-size: 2rem; font-weight: 700; margin: 0.5rem 0; }
        .summary-score { font-size: 4.5rem; font-weight: 800; margin: 1rem 0; }
        .summary-stats { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-top: 1.5rem; }
        .summary-stat { text-align: center; }
        .summary-stat-value { font-size: 1.75rem; font-weight: 600; }
        .summary-stat-label { font-size: 0.875rem; opacity: 0.8; }

        /* Main Grid Layout */
        .results-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start; }

        .card { background-color: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; }
        .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        
        /* Answer Review Section */
        .question-filter { margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .filter-btn { background: var(--muted); border: 1px solid var(--border); color: var(--muted-foreground); padding: 0.5rem 1rem; border-radius: 999px; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .review-question { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
        .review-question:last-child { border-bottom: none; }
        .review-question-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;}
        .review-question-topic { font-size: 0.8rem; background-color: var(--muted); padding: 0.2rem 0.6rem; border-radius: 0.25rem; color: var(--muted-foreground);}
        .status-tag { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 500; }
        .status-correct { background-color: #dcfce7; color: #15803d; }
        .status-incorrect { background-color: #fee2e2; color: #b91c1c; }
        .status-unanswered { background-color: #ffedd5; color: #9a3412; }
        
        .review-options .option { display: flex; gap: 1rem; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border: 1px solid var(--border); }
        .review-options .option.correct-answer { background-color: #dcfce7; border-color: #4ade80; }
        .review-options .option.incorrect-choice { background-color: #fee2e2; border-color: #f87171; text-decoration: line-through; }
        .review-options .option-label { font-weight: 600; }
        .solution { margin-top: 1rem; padding: 1rem; background-color: #e0f2fe; border-left: 4px solid #38bdf8; }
        .solution h4 { color: #0369a1; margin-bottom: 0.5rem; }

        /* Right Sidebar */
        .sidebar-card { position: sticky; top: 5rem; }
        .subject-breakdown .subject-item { margin-bottom: 1rem; }
        .subject-header { display: flex; justify-content: space-between; font-weight: 500; margin-bottom: 0.5rem; }
        .progress-bar { width: 100%; height: 0.5rem; background-color: var(--muted); border-radius: 999px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: var(--primary); transition: width 0.5s ease; }
        
        .time-analysis .time-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
        .time-analysis .time-item:last-child { border-bottom: none; }
        .time-label { color: var(--muted-foreground); }
        .time-value { font-weight: 600; }

        .action-buttons { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .btn { padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; text-decoration: none; text-align: center; transition: all 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; border: 1px solid var(--primary); }
        .btn-outline { background-color: transparent; color: var(--primary); border: 1px solid var(--primary); }
        
        @media (max-width: 992px) {
            .results-grid { grid-template-columns: 1fr; }
            .sidebar-card { position: static; }
            .summary-score { font-size: 3.5rem; }
            .summary-test-name { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="dashboard.html" class="nav-brand">ExamAce</a>
            <div class="nav-user"><div class="user-avatar" id="user-avatar">U</div></div>
        </div>
    </nav>

    <main class="main-container">
        <div id="loading-state"><h1>Calculating Results...</h1></div>
        <div id="results-content" style="display:none;">
            <section class="summary-header">
                <div class="summary-title">Your Score for</div>
                <h1 class="summary-test-name" id="test-name">Test Name</h1>
                <div class="summary-score" id="final-score">0 / 0</div>
                <div class="summary-stats">
                    <div class="summary-stat"><div class="summary-stat-value" id="stat-correct">0</div><div class="summary-stat-label">Correct</div></div>
                    <div class="summary-stat"><div class="summary-stat-value" id="stat-incorrect">0</div><div class="summary-stat-label">Incorrect</div></div>
                    <div class="summary-stat"><div class="summary-stat-value" id="stat-unanswered">0</div><div class="summary-stat-label">Unanswered</div></div>
                    <div class="summary-stat"><div class="summary-stat-value" id="stat-accuracy">0%</div><div class="summary-stat-label">Accuracy</div></div>
                </div>
            </section>

            <div class="results-grid">
                <div class="card" id="answer-review-card">
                    <h2 class="card-title">Detailed Analysis</h2>
                    <div class="question-filter" id="question-filter">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="correct">Correct</button>
                        <button class="filter-btn" data-filter="incorrect">Incorrect</button>
                        <button class="filter-btn" data-filter="unanswered">Unanswered</button>
                    </div>
                    <div id="review-container"></div>
                </div>

                <div class="sidebar">
                    <div class="card sidebar-card">
                        <div class="subject-breakdown">
                            <h2 class="card-title">Subject-wise Performance</h2>
                            <div id="subject-container"></div>
                        </div>
                        <div class="time-analysis" style="margin-top: 2rem;">
                             <h2 class="card-title">Time Analysis</h2>
                             <div id="time-container"></div>
                        </div>
                         <div class="action-buttons">
                            <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
                            <a href="test-selection.html" class="btn btn-outline">Take Another Test</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCQ34ZAWWCMuaQ01fvX0sI-YdklK0mJ5aw",
          authDomain: "testseries-38752.firebaseapp.com",
          projectId: "testseries-38752",
          storageBucket: "testseries-38752.firebasestorage.app",
          messagingSenderId: "519384534407",
          appId: "1:519384534407:web:201265a9d703708334d722"
        };
      
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        class DetailedResultsPage {
            constructor() {
                this.results = null;
                this.user = null;
                onAuthStateChanged(auth, user => {
                    if (user) {
                        this.user = user;
                        document.getElementById('user-avatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
                        this.loadResults();
                    } else {
                        window.location.href = 'login.html';
                    }
                });
            }

            loadResults() {
                const resultsStr = sessionStorage.getItem('test_results');
                if (!resultsStr) {
                    document.getElementById('loading-state').innerHTML = '<h1>No results found. Please complete a test first.</h1><br/><a href="test-selection.html">Go to tests</a>';
                    return;
                }
                try {
                    this.results = JSON.parse(resultsStr);
                    this.saveResultsToFirestore(); // Renamed to be more specific
                    this.renderPage();
                } catch (error) {
                    console.error('Error parsing results:', error);
                    document.getElementById('loading-state').innerHTML = '<h1>Error loading results. The data might be corrupted.</h1>';
                }
            }
            
            async saveResultsToFirestore() {
                // Using the test ID and timestamp to create a unique ID for the result document
                const resultId = `${this.results.testData.id}_${this.results.completedAt}`;
                
                // MODIFIED: This object contains all the necessary flat data for analytics
                const resultSummary = {
                    testId: this.results.testData.id,
                    testTitle: this.results.testData.title,
                    userId: this.user.uid,
                    completedAt: this.results.completedAt,
                    score: this.results.finalScore,
                    totalMarks: this.results.testData.marks,
                    percentage: this.results.percentage,
                    correct: this.results.correct,
                    incorrect: this.results.incorrect,
                    unanswered: this.results.unanswered,
                    subjectWise: this.results.subjectWise,
                    timeTaken: this.results.timeTaken,
                    incorrectTopics: this.results.incorrectTopics || [] // Ensure it's always an array
                };
                try {
                    const resultRef = doc(db, "users", this.user.uid, "results", resultId);
                    await setDoc(resultRef, resultSummary);
                    console.log("Result saved to Firestore successfully.");
                } catch (error) {
                    console.error("Error saving result to Firestore: ", error);
                }
            }

            renderPage() {
                this.renderSummary();
                this.renderSubjectBreakdown();
                this.renderTimeAnalysis();
                this.renderAnswerReview();
                this.setupFilters();

                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('results-content').style.display = 'block';
            }

            renderSummary() {
                const attempted = this.results.correct + this.results.incorrect;
                const accuracy = attempted > 0 ? ((this.results.correct / attempted) * 100).toFixed(1) : 0;

                document.getElementById('test-name').textContent = this.results.testData.title;
                document.getElementById('final-score').textContent = `${this.results.finalScore} / ${this.results.testData.marks}`;
                document.getElementById('stat-correct').textContent = this.results.correct;
                document.getElementById('stat-incorrect').textContent = this.results.incorrect;
                document.getElementById('stat-unanswered').textContent = this.results.unanswered;
                document.getElementById('stat-accuracy').textContent = `${accuracy}%`;
            }

            renderSubjectBreakdown() {
                const container = document.getElementById('subject-container');
                container.innerHTML = '';
                const subjects = this.results.subjectWise;
                for (const subjectName in subjects) {
                    const data = subjects[subjectName];
                    const attempted = data.correct + data.incorrect;
                    const accuracy = attempted > 0 ? ((data.correct / attempted) * 100) : 0;
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'subject-item';
                    subjectDiv.innerHTML = `
                        <div class="subject-header">
                            <span>${subjectName}</span>
                            <span>${accuracy.toFixed(1)}% Accuracy</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${accuracy}%"></div>
                        </div>
                        <div style="font-size: 0.8rem; text-align: right; margin-top: 0.25rem;">
                           C: ${data.correct}, I: ${data.incorrect}, U: ${data.unanswered}
                        </div>
                    `;
                    container.appendChild(subjectDiv);
                }
            }
            
            renderTimeAnalysis() {
                const container = document.getElementById('time-container');
                const timeTaken = this.results.timeTaken || 0;
                const attemptedCount = this.results.correct + this.results.incorrect;
                const avgTime = attemptedCount > 0 ? (timeTaken / attemptedCount).toFixed(0) : 0;

                const formatTime = (seconds) => {
                    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const s = (seconds % 60).toString().padStart(2, '0');
                    return `${m}m ${s}s`;
                };

                container.innerHTML = `
                    <div class="time-item"><span class="time-label">Time Taken</span><span class="time-value">${formatTime(timeTaken)}</span></div>
                    <div class="time-item"><span class="time-label">Total Time</span><span class="time-value">${this.results.testData.duration}m 00s</span></div>
                    <div class="time-item"><span class="time-label">Avg. Time/Ques</span><span class="time-value">${avgTime}s</span></div>
                `;
            }

            renderAnswerReview(filter = 'all') {
                const container = document.getElementById('review-container');
                container.innerHTML = '';
                
                this.results.testData.questions_data.forEach((q, index) => {
                    const userAnswer = this.results.answers[index];
                    const isCorrect = userAnswer === q.correctAnswer;
                    let status = 'unanswered';
                    if (userAnswer !== undefined) status = isCorrect ? 'correct' : 'incorrect';
                    
                    if (filter !== 'all' && filter !== status) return;

                    const questionEl = document.createElement('div');
                    questionEl.className = 'review-question';
                    questionEl.dataset.status = status;

                    questionEl.innerHTML = `
                        <div class="review-question-header">
                            <span><b>Q${index + 1}:</b> (${q.subject})</span>
                            <div>
                                <span class="review-question-topic">${q.topic || 'General'}</span>
                                <span class="status-tag status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                            </div>
                        </div>
                        <p>${q.questionText}</p>
                        <div class="review-options">
                            ${q.options.map((option, optIndex) => `
                                <div class="option 
                                    ${optIndex === q.correctAnswer ? 'correct-answer' : ''}
                                    ${optIndex === userAnswer && !isCorrect ? 'incorrect-choice' : ''}
                                ">
                                    <span class="option-label">${String.fromCharCode(65 + optIndex)}.</span>
                                    <span>${option}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="solution">
                            <h4>Solution:</h4>
                            <p>${q.solution || 'No detailed solution available.'}</p>
                        </div>
                    `;
                    container.appendChild(questionEl);
                });
            }
            
            setupFilters() {
                const filterContainer = document.getElementById('question-filter');
                filterContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        filterContainer.querySelector('.active').classList.remove('active');
                        e.target.classList.add('active');
                        this.renderAnswerReview(e.target.dataset.filter);
                    }
                });
            }
        }

        new DetailedResultsPage();
    </script>
</body>
</html>
